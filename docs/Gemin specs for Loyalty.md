To provide **Antigravity AI** (or any AI-driven IDE) with a "no-guesswork" blueprint, I have expanded the documentation to include specific logic for South African SMS integration, the high-security "Dynamic QR" signing process, and the multi-tenant directory scaffolding.

---

### Document 1: Expanded_PRD.md

```markdown
# Product Requirements Document: Digital Loyalty "As-a-Service"

## 1. Core Workflow: Merchant-Scan-Customer
To minimize hardware costs for the merchant, we use a "Scan-to-Stamp" model.

- **The Member QR:** This is NOT a static ID. It is a dynamic, signed token generated by the Member's PWA that rotates every 60 seconds.
- **The Merchant Scanner:** A dedicated "Staff View" within the PWA that utilizes the device camera to decode the Member QR and hit the `/issue-stamp` endpoint.

## 2. Authentication & SMS Integration (South African Context)
- **Primary Auth:** Mobile number + 4-digit OTP.
- **Provider Recommendation:** **SMSPortal** or **BulkSMS.com** (South African Tier-1 Aggregators).
- **Logic:** 1. User enters `+27` number.
  2. Backend generates 4-digit random string, stores in Redis/Cache with 5-minute TTL.
  3. Backend calls SMSPortal API to deliver the code.
  4. User enters code -> JWT is issued.

## 3. Detailed Acceptance Criteria (AC)

### AC 1: Multi-Tenant Isolation
- **GIVEN** a request to `/api/member/profile`
- **WHEN** the JWT belongs to `Vendor_A`
- **THEN** the system MUST NOT return data for `Vendor_B`, even if the Member's phone number exists in both.

### AC 2: Fraud Prevention (Velocity Limit)
- **GIVEN** a successful stamp issuance
- **WHEN** the same Merchant tries to stamp the same Member within 60 minutes
- **THEN** the system MUST return a `429 Too Many Requests` error to prevent "double-stamping" accidents or fraud.

### AC 3: "Add to Home Screen" Prompt
- **GIVEN** a user visits the root URL
- **WHEN** the browser is Chrome (Android) or Safari (iOS)
- **THEN** the PWA MUST trigger the native "Install App" or "Add to Home Screen" overlay.

```

---

### Document 2: Expanded_Architecture.md

```markdown
# Technical Architecture: Multi-Tenant Node.js PWA

## 1. Directory Structure (Scaffolding for Antigravity)
```text
/loyalty-platform
├── /src
│   ├── /api
│   │   ├── /middleware (auth.js, tenant.js, rateLimit.js)
│   │   ├── /routes (vendor.js, member.js, merchant.js, auth.js)
│   │   └── /controllers
│   ├── /services
│   │   ├── smsService.js (SMSPortal integration)
│   │   ├── qrService.js (Dynamic QR signing logic)
│   │   └── tenantService.js (Branding & Config loader)
│   ├── /models (Prisma or Sequelize models)
│   └── server.js
├── /public (PWA assets: manifest.json, service-worker.js)
├── .env (VENDORS_DB_URL, JWT_SECRET, SMS_API_KEY)
└── docker-compose.yml (For local dev before Afrihost deploy)

```

## 2. Dynamic QR Security Logic (The "Anti-Screenshot" Fix)

To prevent members from sharing a screenshot of their QR card:

* **Payload:** `{"m": "member_uuid", "v": "vendor_uuid", "t": "timestamp"}`
* **Signature:** `HMAC_SHA256(payload, SERVER_SECRET)`
* **Validation:** - Merchant scans -> Backend checks if `timestamp` is < 120 seconds old.
* Backend verifies HMAC signature.
* If valid, increment stamp.



## 3. JWT Payload Structure

```json
{
  "sub": "user_uuid",
  "vid": "vendor_uuid",
  "role": "member", // or "merchant" / "admin"
  "iat": 1715600000
}

```

*Note: The `vid` (Vendor ID) is baked into the token to ensure the middleware always scopes database queries to the correct tenant.*

```

---

### Document 3: Technical_Implementation_Specs.md

```markdown
# Implementation Specs for AI-Assisted Development

## 1. SMS Gateway Integration (Node.js snippet)
**Service:** SMSPortal (Local SA Provider)
**API End-point:** `https://rest.smsportal.com/v1/bulkmessages`
```javascript
async function sendOTP(phoneNumber, code) {
  const message = `Your Loyalty Code is: ${code}. Valid for 5 mins.`;
  // Implementation should use Axios to POST to SMSPortal 
  // with Authorization: Basic [Base64(API_ID:API_SECRET)]
}

```

## 2. PWA Manifest for Multi-Tenancy

The `manifest.json` must be served dynamically.

* **Endpoint:** `/v1/:vendor_slug/manifest.json`
* **Logic:** Fetch `branding_config` from DB and return a JSON object with the Vendor's name and icons. This allows each "App" on the home screen to have the specific business's icon.

## 3. Afrihost VPS Deployment Checklist

1. **Nginx Config:** Set up as a Reverse Proxy to port `3000`.
2. **Environment Variables:**
* `DB_HOST`, `DB_USER`, `DB_PASS` (Afrihost MySQL/Postgres details)
* `JWT_SECRET` (Long random string)
* `SMS_GATEWAY_CREDENTIALS`


3. **SSL:** Install `certbot` and run `sudo certbot --nginx` to ensure the PWA is served over HTTPS (required for Camera/Scanner access).

## 4. Database Initialization Script

Provide the IDE with this starting SQL:

```sql
CREATE TABLE vendors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    slug VARCHAR(50) UNIQUE NOT NULL,
    brand_name VARCHAR(100),
    primary_color VARCHAR(7) DEFAULT '#000000',
    stamp_count_required INT DEFAULT 10
);
-- Add additional tables for members and stamps with vendor_id FK.

